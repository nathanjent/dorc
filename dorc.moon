-- title:  Daring Orc
-- author: Nathan Jent
-- desc:   Jump and Slash!
-- script: moon

t=0
hitbox=true
player=
	x:120
	y:68
	w:9
	h:15
	vx:0
	vy:0
	ax:1
	ay:.2
	fx:.9
	jmp:-3
	state:"idle"
	tic:0
	transcolor:14
	states:
		idle:
			sprt: 256
			framecnt:1
			trans:14
			ox:-2
			oy:-1
			w:2
			h:2
		attack:
			sprt: 258
			framecnt:3
			trans:14
			ox:-5
			oy:-1
			w:3
			h:2
		jump:
			sprt:320
			framecnt:1
			trans:14
			ox:-2
			oy:-1
			w:2
			h:2
		walk:
			sprt:288
			framecnt:2
			trans:14
			ox:-2
			oy:-1
			w:2
			h:2

-- flag as byte
fget8=(id)->peek 0x14404+id

solid=(x,y)->fget(mget(x//8,y//8),0)
aabb=(o)->
	o.x+o.vx,o.y+o.vy,o.x+o.vx+o.w-1,o.y+o.vy+o.h-1

collision=(o)->
	x1,y1,x2,y2=aabb o
	for x=x1,x2
		for y=y1,y2
			if solid(x,y)
				return true

groundCollision=(o)->
	x1,_,x2,y2=aabb o
	solid(x1,y2+1) or solid(x2,y2+1)

ceilingCollision=(o)->
	x1,y1,x2,_=aabb o
	solid(x1,y1) or solid(x2,y1)

export draw=(o)->
	-- sprites from state data
	stdata=o.states[o.state or "idle"]
	o.curframe=o.curframe or 0
	id=stdata.sprt+o.curframe*stdata.w
	fhold=fget8 id
	if o.tic>fhold
		print "hi"
		o.curframe+=1
		o.tic=0
	if o.curframe>=stdata.framecnt or fhold==0
		print "yo"
		o.curframe=0
	id=stdata.sprt+o.curframe*stdata.w
	x=o.x+stdata.ox
	y=o.y+stdata.oy
	w=stdata.w
	h=stdata.h
	s=o.scale or 1
	f=o.flip or 0
	print "id:#{id}"
	print "fhold:#{fhold}"
	print "curframe:#{o.curframe}"
	print "framecnt:#{stdata.framecnt}"
	spr id,x%240,y%136,stdata.trans,s,f,0,w,h
	if hitbox
		rectb o.x%240,o.y%136,o.w,o.h,3

export TIC=->
	-- input
	if player.state!="attack" and btnp 6
		player.state="attack"
	if btn 2
		player.vx=-1
		player.flip=1
	else if btn 3
		player.vx=1
		player.flip=0
	else
		player.vx=0

	if collision player
		player.vx=0

	if groundCollision player
		player.vy=0
		if player.state=="jump"
			player.state="idle"
	else
		player.vy+=player.ay

	if player.vy==0 and btnp 4
		player.vy=player.jmp
		player.state="jump"

	if ceilingCollision player
		player.vy=0

	-- apply physics
	player.vx*=player.fx
	player.x+=player.vx
	player.y+=player.vy

	cls!
	map (player.x//240)*30,(player.y//136)*17,30,17,0,0,0
	draw player,t
	t+=1
	player.tic+=1

-- <TILES>
-- 015:0ffffff0feeeeeefeee4eeeefe4e5eeffee3e5efee4e4eeefeeeeeef0feffef0
-- </TILES>

-- <SPRITES>
-- 000:eeeeee2eeeeee777eeee76667777622276676666e76766c0ee776666eee76666
-- 001:22eeeeee7777eeee66667eee6662277726266767666c077e666667eec66c67ee
-- 002:eeeeee2eeeeee777eeee76667777622276676666e76766c0ee776666eee76666
-- 003:22eeeeee7777eeee66667eee6662277726266767666c077e666667eec66c67ee
-- 004:eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeddeeeedddcee
-- 005:eeeeee2eeeeee777eeee76667777622276676666e76766c0ee776666eee76661
-- 006:22eeeeee7777eeee66667eee6662277726266767666c077e666667ee111667ee
-- 007:eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeceeeeeceeeee
-- 008:eeeeee2eeeeee777eeee76667777622276676666e76766c0ee776666eee76666
-- 009:22eeeeee7777eeee66667eee6662277726266767666c077e666667eec66c67ee
-- 010:eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
-- 016:eeee7661eeeff766eefddf77eeeff812eee7681deee76888eee77899eeeee888
-- 017:111267ee66667eee7777dfee222ff7eedddd767edddd767d899d777e8888eeee
-- 018:eeeff661eefddf66ee7fdf77e766f812e7677812e77ee888eeee8998eeee888e
-- 019:111267ee66667f777777df67222ff7772228eeee8888eeeee898eeeee888eeee
-- 020:ddddceeeddcceeeeecceeeeeececeeeeeeceeeeeeceeeeeececeeeeeeceeeeee
-- 021:eeeff61ceefddf61e76fdf77e767f812ee77e812eeeee888eeee8998eeee888e
-- 022:00c167ee11267fee7777df77222ff6672228e7778888eeeee898eeeee888eeee
-- 023:eeeecceecccccdeeddddddeedddddeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
-- 024:eeeff661eefddf66ee7fdf77e766f812e7677812e77ee888eeee8998eeee888e
-- 025:111267ee66667eee7777dfee222ff67e2228767c8888e77de898eeede888eeee
-- 026:eeeeeeeeeeeceeeeeceeeceeeeeeeeeecccceeeedddddeeeddddeeeeeeeeeeee
-- 032:eeeeee2eeeeee777eeee76667777622276676666e76766c0ee776666eee76666
-- 033:22eeeeee7777eeee66667eee6662277726266767666c077e666667eec66c67ee
-- 034:eeeeee2eeeeee777eeee76666667622265576666e65766c0ee676666eee76666
-- 035:22eeeeee7777eeee66667eee6662276626266756666c076e666667eec66c67ee
-- 048:eeee7661eeeff766eefddf77ee7ff81dee767812ee767888eee77899eeeee888
-- 049:111267ee66667fee7777fdfeddddff7ddddd767e888d767e8e8998ee8e8888ee
-- 050:eeee7661eeeff766eefddf77ee7ff812ee76781dee778888eeee898eeeee888e
-- 051:111267ee66667eee7777dfee222ff7eedddd767edddd767d899d777e8888eeee
-- 064:eeeeee2eeeeee777eeee76667777622276676666e76766c0ee7766cceee76666
-- 065:22eeeeee7777eeee66667eee6662277726266767666c077e666cc7ee666667ee
-- 066:eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
-- 067:eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
-- 080:eeeff666eefddf61ee7fdf77e766f812e7677812e77ee888eeee8998eeee888e
-- 081:c66c67ee11127f777777df67222ff7dd2228eddd8888dddeee89ddeeee888eee
-- 082:eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
-- 083:eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
-- </SPRITES>

-- <MAP>
-- 000:f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0000000000000000000000000000000000000000000000000000000f0f0f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 001:f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0000000000000000000000000000000000000000000000000f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 002:f0f00000000000000000000000000000000000000000000000000000f0f0f0f0000000000000000000000000000000000000000000000000000000f0f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 003:f0f00000000000000000000000000000000000000000000000000000f0f0f0f000000000000000000000f0f0f00000000000000000000000000000f0f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 004:f0f00000000000000000000000000000000000000000000000000000f0f0f0f0000000000000000000f0f000000000000000000000000000000000f0f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 005:f0f00000000000000000000000000000000000000000000000000000f0f0f0f0000000000000000000000000000000000000000000000000000000f0f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 006:f0f00000000000000000000000000000000000000000000000000000f0f0f0f0000000000000000000000000000000f0f0f0000000000000000000f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 007:f0f0000000000000000000000000000000000000000000000000f0f0f0f0f0f0000000000000000000000000000000000000000000000000000000f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 008:f0f00000000000000000000000000000000000000000f00000000000000000000000000000000000000000000000000000000000f0f00000000000f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 009:f0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f0f0000000000000f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 010:f0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f0f0f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 011:f0f000000000000000000000000000000000000000f0f0f00000f0f0f0f0f0f0f0f0000000f0f000000000f0f0f000000000000000000000000000f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 012:f0f000000000f0f0f0f0f00000000000f0f000000000000000000000f0f0000000f000000000000000000000f0f0f0000000000000000000000000f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 013:f0f00000f000f000000000000000f0f0f0f0f0000000000000000000f0f0000000f0f000000000000000000000f0f0f0000000000000f0f0f00000f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 014:f0f0000000000000000000000000f0f0f0f0f0f00000000000000000f0f0000000f000000000000000000000000000000000000000000000000000f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 015:f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0000000f000000000000000000000000000000000000000000000000000f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 016:f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0000000f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 017:0000000000000000000000000000000000000000000000000000000000000000000000000000f0f0f0f0f0000000000000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </MAP>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- </WAVES>

-- <SFX>
-- 000:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304000000000
-- </SFX>

-- <FLAGS>
-- 000:00000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 001:10103030005050003030000000000000101030300050500030300000000000003030303000000000000000000000000030303030000000000000000000000000101000000000000000000000000000001010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </FLAGS>

-- <PALETTE>
-- 000:1a1c2c5d275db13e53ef7d57ffcd75a7f07038b76425717929366f3b5dc941a6f673eff7f4f4f494b0c2566c86333c57
-- </PALETTE>

