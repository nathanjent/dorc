-- title:  Daring Orc
-- author: Nathan Jent
-- desc:   Jump and Slash!
-- script: moon

t=0
hitbox=false
player=
	x:20
	y:104
	vx:0
	vy:0
	ax:.1
	ay:.2
	mvx:1.3
	fx:.9
	jmp:-3.1
	state:"idle"
	tic:0
	transcolor:14
	states:
		idle:
			sprt: 256
			framecnt:1
			ox:-3
			oy:-1
			cw:11
			ch:15
			w:2
			h:2
		attack:
			norepeat:true
			sprt: 258
			framecnt:4
			ox:-3
			oy:-1
			cw:11
			ch:15
			w:3
			h:2
		jump:
			sprt:320
			framecnt:1
			ox:-3
			oy:-1
			cw:11
			ch:15
			w:2
			h:2
		walk:
			sprt:288
			framecnt:2
			ox:-2
			oy:-1
			cw:11
			ch:15
			w:2
			h:2

-- flag as byte
fget8=(id)->peek 0x14404+id

solid=(x,y)->fget(mget(x//8,y//8),0)
aabb=(o)->
	stdata=o.states[o.state or "idle"]
	w=stdata.cw
	h=stdata.ch
	o.x+o.vx,o.y+o.vy,o.x+o.vx+w-1,o.y+o.vy+h-1

collision=(o)->
	x1,y1,x2,y2=aabb o
	for x=x1,x2
		for y=y1,y2
			if solid(x,y)
				return true

groundCollision=(o)->
	x1,_,x2,y2=aabb o
	solid(x1,y2+1) or solid(x2,y2+1)

ceilingCollision=(o)->
	x1,y1,x2,_=aabb o
	solid(x1,y1) or solid(x2,y1)

export draw=(o)->
	-- sprites from state data
	stdata=o.states[o.state or "idle"]
	o.curframe=o.curframe or 0

	-- get frame hold time
	fhold=fget8 stdata.sprt+o.curframe*stdata.w

	-- cycle frames after each frame hold
	if o.tic>fhold
		o.curframe+=1
		o.tic=0
	if o.curframe>=stdata.framecnt or fhold==0
		o.curframe=0
	id=stdata.sprt+o.curframe*stdata.w

	w=stdata.w
	h=stdata.h
	s=o.scale or 1
	f=o.flip or 0
	t=stdata.trans or 0
	-- TODO fix offset when flipped
	x=o.x+stdata.ox
	y=o.y+stdata.oy
	spr id,x%240,y%136,t,s,f,0,w,h

	if hitbox
		rectb o.x%240,o.y%136,stdata.cw,stdata.ch,3

export TIC=->
	-- input
	if player.state!="attack" and btnp 5
		player.state="attack"
	if btn 2
		if player.vx>-player.mvx
			player.vx-=player.ax
		player.flip=1
		if player.state=="idle"
			player.state="walk"
	else if btn 3
		if player.vx<player.mvx
			player.vx+=player.ax
		player.flip=0
		if player.state=="idle"
			player.state="walk"

	if collision player
		player.vx=0

	if player.vx>-.1 and player.vx<.1 and player.state=="walk"
		player.state="idle"

	if groundCollision player
		player.vy=0
		if player.state=="jump"
			player.state="idle"
	else
		player.vy+=player.ay

	if player.vy==0 and btnp 4
		player.vy=player.jmp
		player.state="jump"

	if ceilingCollision player
		player.vy=0

	stdata=player.states[player.state]
	if stdata.norepeat and (player.curframe or 0)+1>=stdata.framecnt
		player.state="idle"

	-- apply physics
	player.vx*=player.fx
	player.x+=player.vx
	player.y+=player.vy

	cls!
	map (player.x//240)*30,(player.y//136)*17,30,17,0,0,0
	draw player,t
	print "player state: #{player.state}",1,1,4
	print "player curframe: #{player.curframe}",1,8,4
	print "player state framecnt: #{stdata.framecnt}",1,15,4
	t+=1
	player.tic+=1

-- <TILES>
-- 001:fffffffffffff8ffff9fffffffffff9fffffffffffff9ffff8ffffffffffffff
-- 002:fffffffffffffffffff8ffffff8fffffffffff8ffffffffffff8ffffffffffff
-- 015:0ffffff0feeeeeefeee4eeeefe4e5eeffee3e5efee4e4eeefeeeeeef0feffef0
-- 206:08888f80f88f888f8eeee8eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
-- 208:ddddddddddddddddddddddddddddddddddddddddddddddddddddddd9dddddd98
-- 209:dddddddddddddddddddddddddddddddddddddddddddddddd9ddddddd99dddddd
-- 210:dddddddddddddddddddddddfddddddffddddffffddffffffffffffffffffffff
-- 211:dfffffffddffffffdddfffffdddddfffddddddffdddddddfdddddddfdddddddd
-- 221:ffeeeeeefeeeeefeeeeeeeeeeefeeeeeeeeeeeeefeeeeeeefeeeefeefeeeeeee
-- 222:eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
-- 223:eeeeeeffeeeeeeefefeeeeefeeeeeeefeeeefeeeeeeeeeeeeeeeeeefeeeeeeff
-- 224:ddddd988dddd888fdddfffffddffff8fdfff8fffffffffff7777777777777777
-- 225:989dddddff89ddddfff88dddffffffddff8ffffdffffffff7777777777777777
-- 226:dddddddddddddddddddddddddddddddddddddddddddddddd7777777777777777
-- 227:dddddddddddddddeddddddeeddddddeedddddeeeddddeefeddeeeeeedeeeeeee
-- 228:2332332d2332332d2323333d3323333d3323233d3333232d3233232d3233332d
-- 237:feeeeeeefeeefeeefeeeeeeefeeeeeeefeeeeeeefeefeeeefeeeeefefeeeeeee
-- 238:eeeeeeeeeefeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeefeefeeeeeeeeeeeeee
-- 239:eeeeeeffeefeeeffeeeeeeffeeeeeeffeeeefeefeeeeeeefeeeeeeefeeeeeeef
-- 240:dddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddd
-- 241:6666666636663366336333333333232372377272377277777777777777777277
-- 242:7777777777777777727777777777377777777777777777277727777777777777
-- 244:3233232d3333232d2323233d2323333d33232333333123233131131311111111
-- 253:feeeeeeefeeeeeeefeefeeeefeeeeeeeffeeeeeefffeeeeeffffeeeeffffffff
-- 254:eeeeeeeeeeeeeeeeefeeeeeeeeeeeeeeeeeeefeeeeeeeeeeeeeeeeeeffffffff
-- 255:eeeeeeefeeeeeeefeeeeeeefeeefeeefeeeeeeffeeeeeeffeeeeefffffffffff
-- </TILES>

-- <SPRITES>
-- 000:0000002000000777000076667777622276676666076766c80077666600076666
-- 001:2200000077770000666670006662276626266756666c876066666700c66c6700
-- 002:0000002000000777000076667777622276676666076766c80077666600076666
-- 003:2200000077770000666670006662276626266756666c876066666700c66c6700
-- 004:0000000000000000000000000000000000000000000000000000ee0000eeed00
-- 005:0000002000000777000076667777622276676666076766c80077666600076661
-- 006:2200000077770000666670006662276626266756666c87606666670011166700
-- 007:0000000000000000000000000003000000000000000003000000000000002000
-- 008:0000002000000777000076667777622276676666076766c80077666600076661
-- 009:2200000077770000666670006662276626266756666c87606666670011166700
-- 010:0000000000004000000000000000000400000000000000000003000000000030
-- 011:0000002000000777000076667777622276676666076766c80077666600076666
-- 012:2200000077770000666670006662276626266756666c876066666700c66c6700
-- 013:0000000000000000000000000000000000004000000000000000000400000000
-- 016:00007661000ff76600fddf77000ff8120007681e000768880007789900000888
-- 017:11126700666670007777df00222ff700dddd7670eeee767e899e777088880000
-- 018:000ff66100fddf66007fdf770766f8120767781207700888000089980000888e
-- 019:1112670066667f777777df67222ff777222800008888000ce8980040e8880000
-- 020:eeeedc00eedd2000ddc3c000dc2c000003c000000c000000c000000000000000
-- 021:000ff61c00fddf61076fdf770767f81200770812000008880000899800008880
-- 022:ffc1670011267f007777df77222ff66722280777888800000898004008880000
-- 023:02000d00ddddde00eeeeee00eeeee00000000000000000000000000000000000
-- 024:000ff61c00fddf61007fdf770766f81207677812077008880000899800008880
-- 025:ffc16700112670007777df00222ff67d2228767d8888077e0898000e08880000
-- 026:00000000000000000002000020000000ddddd000eeeee000eeee000000000000
-- 027:00076661000ff66600fddf77007ff81200767812007778880000899800008880
-- 028:11126700666670007777df00222ff7002228eee08888eeee0898eee008880000
-- 029:0000000000000300030000000000000000000000000000000000000000000000
-- 032:0000002000000777000076667777622276676666076766c80077666600076666
-- 033:2200000077770000666670006662276626266756666c876066666700c66c6700
-- 034:0000002000000777000076667777622276676666076766c80077666600076666
-- 035:2200000077770000666670006662276626266756666c876066666700c66c6700
-- 048:00007661000ff76600fddf77007ff81e00767812007678880007789900000888
-- 049:1112670066667f007777fdf0edddff7eeeee7670888e76708089980080888800
-- 050:00007661000ff76600fddf77007ff8120076781e007788880000898000008880
-- 051:11126700666670007777df00222ff700dddd7670eeee767e899e777088880000
-- 064:0000002000000777000076667777622276676666076766c8007766cc00076666
-- 065:2200000077770000666670006662276626266756666c8760666cc70066666700
-- 080:000ff66600fddf61007fdf770766f81207677812077008880000899800008880
-- 081:c66c670011127f777777df67222ff7de22280dee8888dee00089ee0000888000
-- </SPRITES>

-- <MAP>
-- 000:0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0fededededededededededededededededededeeeeeeededeeeeeeeeeeedededeeeeededeeedfff0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ed
-- 001:0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0fedededeeededeeedededededeeededeeeeeeeeeeedededededededededeeeeedeeeeedededf0f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ed
-- 002:0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0fedeeeeedededeeededededeeeeeeedeeeeedededff2020202020dfeeedededeeeeededfff0f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ed
-- 003:0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0fedeeededededeeedeeeeeeededededeeededff2020202020201010eeedeeedededeefff0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ed
-- 004:0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0feeedeeedededeeeeeeeeeeededededededff202020202020101020deedededf0f0f0f0f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ed
-- 005:2f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f3eeeeeededeeededeeedeeedeeedededff2020202020202020101010dfefeff0f0f0f0f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ed
-- 006:2f2f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f3eedeeedededededededeeeeeeedededff2020202020202020202010201020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ed
-- 007:2f2f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f3eedeeedeeedededeeededeeeeededefff202010202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ed
-- 008:2f2f2f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f3eededededededeeedededededededff2020202010102020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ed
-- 009:2f2f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f3eedeeededededeeededededeeeeedff202020202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ed
-- 010:4e0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f3eedededeeededeeededeeeeeeeeeeff2020202020202020202020202020202020f0f0f0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ed
-- 011:4e0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0fedeeeeedeeedeeefefefefefefefff202020101010202020202020101020202020ddeeeefdf0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ed
-- 012:4e0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f3d2020202020202020202020202020202020102020202020201010101020202020eeeeeeedfdf0f0f0f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ed
-- 013:4e0f0f0f0f0f0f0f0f0f0f0f0d1d0f0f0f0f0f0f0f0f0f0f0f3d20202020202020202020202020202020202020f0f0f02020201020f0f0f0f0eeeeedededededfdf0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ed
-- 014:4f2e2e2e2e2e2e2e0e1e2e2e0e1e2e2e2e2e2e0e1e2e2e2e2e2d202020202020202020202020202020202020202020202020202020ddedeeeeeeeeedeeededeeedf0f0f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ed
-- 015:1f1f1f1f1f1f1f1f1f1f1f1f1f1f1f1f1f1f1f1f1f1f1f1f1fedeeedeeeeeeeeeeeeeef0f0f0f0f0202020202020202020202020ddedededededeeedededeeedededfdf0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ed
-- 016:2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2fedeeedeeedeeeeeeeeeeeeedededededececececececececececececededeeededeeeeedededeeededeeedf0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ed
-- 017:000000000000000000000000000000000000000000000000000000000000000000eeee000000f0f0ededededed0000eeededed000000dded0000000000ee00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 018:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ed0000000000000000000000eeee00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 135:00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ee00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </MAP>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- </WAVES>

-- <SFX>
-- 000:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304000000000
-- </SFX>

-- <FLAGS>
-- 000:00000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000001010100000000010000000000000000010101000101000100000000000000000101010
-- 001:1010808080505050808080c0c0c000001010808080505050808080c0c0c000005050505000000000000000000000000050505050000000000000000000000000101000000000000000000000000000001010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </FLAGS>

-- <PALETTE>
-- 000:1a1c2c5d275db13e53ef7d57ffcd75a7f07038b76425717929366f3b5dc941a6f673eff7f4f4f494b0c2566c86333c57
-- </PALETTE>

